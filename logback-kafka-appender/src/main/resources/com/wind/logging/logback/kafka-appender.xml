<?xml version="1.0" encoding="UTF-8"?>
<included>
    <!-- spring property -->
    <springProperty name="KAFKA_TOPIC" scope="context" source="spring.kafka.log.topic"/>
    <springProperty name="KAFKA_SERVERS" scope="context" source="spring.kafka.log.bootstrap-servers"/>
    <springProperty name="KAFKA_ACKS" scope="context" source="spring.kafka.log.acks" defaultValue="all"/>
    <springProperty name="KAFKA_RETRIES" scope="context" source="spring.kafka.log.retries" defaultValue="3"/>
    <springProperty name="KAFKA_COMPRESSION_TYPE" scope="context" source="spring.kafka.log.compression.type" defaultValue="zstd"/>
    <springProperty name="KAFKA_BATCH_SIZE" scope="context" source="spring.kafka.log.batch-size" defaultValue="32768"/>
    <springProperty name="KAFKA_LINGER_MS" scope="context" source="spring.kafka.log.linger.ms" defaultValue="10"/>
    <springProperty name="KAFKA_BUFFER_MEMORY" scope="context" source="spring.kafka.log.buffer-memory" defaultValue="33554432"/>
    <springProperty name="KAFKA_MAX_REQUEST_SIZE" scope="context" source="spring.kafka.log.properties.max-request-size" defaultValue="2097152"/>

    <!-- Kafka Appender -->
    <appender name="KAFKA" class="com.wind.logging.logback.kafka.KafkaAppender">
        <!-- JSON encoder -->
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers class="net.logstash.logback.composite.loggingevent.LoggingEventJsonProviders">
                <pattern>
                    <pattern>
                        {
                        "date": "%d{yyyy-MM-dd HH:mm:ss.SSS}",
                        "A-TraceId": "%X{traceId:-}",
                        "tenant": "%X{tenant:-}",
                        "userId": "%X{userId:-}",
                        "appName": "${APP_NAME}",
                        "env": "${SPRING_PROFILES_ACTIVE:-unkown}",
                        "requestUrl": "%X{requestUrl:-}",
                        "requestSourceIp": "%X{requestSourceIp:-}",
                        "requestSourceHost": "%X{requestSourceHost:-}",
                        "requestSourceReferer": "%X{requestSourceReferer:-}",
                        "userAgent": "%X{userAgent:-}",
                        "podIp": "%X{localhostIpv4:-}",
                        "middlewareType": "%X{middlewareType:-}",
                        "thread": "%thread",
                        "virtualThreadId": "%X{virtualThreadId:-}",
                        "logger": "%logger",
                        "message": "%msg",
                        "level": "%level",
                        "stack_trace": "%exception"
                        }
                    </pattern>
                </pattern>
            </providers>
        </encoder>

        <!-- topic -->
        <topic>${KAFKA_TOPIC}</topic>
        <!-- kafka producer configs -->
        <producerConfig>bootstrap.servers=${KAFKA_SERVERS}</producerConfig>
        <producerConfig>acks=${KAFKA_ACKS}</producerConfig>
        <producerConfig>enable.idempotence=true</producerConfig>
        <producerConfig>compression.type=${KAFKA_COMPRESSION_TYPE}</producerConfig>
        <producerConfig>linger.ms=${KAFKA_LINGER_MS}</producerConfig>
        <producerConfig>delivery.timeout.ms=120000</producerConfig>
        <producerConfig>max.request.size=${KAFKA_MAX_REQUEST_SIZE}</producerConfig>
        <!-- retry/buffer/size -->
        <producerConfig>retries=${KAFKA_RETRIES}</producerConfig>
        <producerConfig>batch.size=${KAFKA_BATCH_SIZE}</producerConfig>
        <producerConfig>buffer.memory=${KAFKA_BUFFER_MEMORY}</producerConfig>
    </appender>

    <!-- Async Disruptor -->
    <appender name="DISRUPTOR_KAFKA" class="net.logstash.logback.appender.LoggingEventAsyncDisruptorAppender">
        <ringBufferSize>8192</ringBufferSize>
        <appender-ref ref="KAFKA"/>
    </appender>
</included>
